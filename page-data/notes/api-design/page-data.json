{"componentChunkName":"component---src-templates-note-template-js","path":"/notes/api-design","result":{"data":{"markdownRemark":{"id":"33a23830-21ea-5d24-a3af-0ddea0cb562c","html":"<h2 id=\"http-method\" style=\"position:relative;\"><a href=\"#http-method\" aria-label=\"http method permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Http method</h2>\n<p>GET:</p>\n<ul>\n<li><code class=\"language-text\">Idempotent</code></li>\n</ul>\n<p>POST:</p>\n<ul>\n<li><code class=\"language-text\">Not Idempotent by definition</code>: Stripe has implementation for this. <a href=\"https://stripe.com/blog/idempotency\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Ref</a></li>\n</ul>\n<p>PUT:</p>\n<ul>\n<li><code class=\"language-text\">Idempotent</code></li>\n<li>Method only allows a complete replacement of a document.</li>\n</ul>\n<p>PATCH:</p>\n<ul>\n<li>Modify an existing HTTP resource.</li>\n</ul>\n<p>DELETE: <br></p>\n<ul>\n<li><code class=\"language-text\">Idempotent</code>: there is a caveat on DELETE. The problem with DELETE, which if successful would normally return a 200 (OK) or 204 (No Content), will often return a 404 (Not Found) on subsequent call <br>\nrespones: 204 no content</li>\n</ul>\n<h2 id=\"authentication\" style=\"position:relative;\"><a href=\"#authentication\" aria-label=\"authentication permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Authentication</h2>\n<h2 id=\"http-headers\" style=\"position:relative;\"><a href=\"#http-headers\" aria-label=\"http headers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Http headers</h2>\n<ul>\n<li><code class=\"language-text\">Accept</code>: Informs the server about the types of data that can be sent back.\nEx:<br/>\n<code class=\"language-text\">Accept: &#39;application/vnd.api+json&#39;</code> is for json api<br/>\n<code class=\"language-text\">Accept: &#39;application/json&#39;</code> is for regular json<br/></li>\n</ul>\n<h2 id=\"idempotency\" style=\"position:relative;\"><a href=\"#idempotency\" aria-label=\"idempotency permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Idempotency</h2>\n<p>Making multiple identical requests has the same effect as making a single request\nThe API supports idempotency for safely retrying requests without accidentally performing the same operation twice.</p>\n<ul>\n<li>Idempotency key: Provide an additional <code class=\"language-text\">Idempotency-Key: &lt;key&gt;</code> header to the request so the request knows it.</li>\n</ul>\n<h2 id=\"rate-limiter-read\" style=\"position:relative;\"><a href=\"#rate-limiter-read\" aria-label=\"rate limiter read permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Rate Limiter <a href=\"https://stripe.com/blog/rate-limiters\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Read</a></h2>\n<h3 id=\"when-do-you-need-rate-limiter\" style=\"position:relative;\"><a href=\"#when-do-you-need-rate-limiter\" aria-label=\"when do you need rate limiter permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>When do you need rate limiter?</h3>\n<ul>\n<li>One of your users is responsible for a <code class=\"language-text\">spike in traffic</code>, and you need to <code class=\"language-text\">stay up for everyone else</code>.</li>\n<li>One of your users has a <code class=\"language-text\">misbehaving script which is accidentally sending you a lot of requests</code>. Or, even worse, one of your users is intentionally trying to overwhelm your servers.</li>\n<li>A user is sending you <code class=\"language-text\">a lot of lower-priority requests</code>, and you want to make sure that it doesn’t affect your high-priority traffic.</li>\n<li>Something in your system has gone wrong internally, and as a result you can’t serve all of your regular traffic and need to drop low-priority requests.</li>\n</ul>\n<h3 id=\"load-shedding\" style=\"position:relative;\"><a href=\"#load-shedding\" aria-label=\"load shedding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Load shedding</h3>\n<ul>\n<li>You can use our API 1000 times a second</li>\n<li>Drop low-priority requests to make sure that more critical requests get through</li>\n</ul>\n<h3 id=\"request-rate-limiter\" style=\"position:relative;\"><a href=\"#request-rate-limiter\" aria-label=\"request rate limiter permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Request rate limiter</h3>\n<ul>\n<li>Restricts each user to N requests per second.</li>\n<li>After analyzing our traffic patterns, we added the ability to briefly burst above the cap for sudden spikes in usage during real-time events (e.g. a flash sale.)</li>\n</ul>\n<h3 id=\"concurrent-rate-limiter\" style=\"position:relative;\"><a href=\"#concurrent-rate-limiter\" aria-label=\"concurrent rate limiter permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Concurrent Rate Limiter</h3>\n<ul>\n<li>You can only have 20 API requests in progress at the same time</li>\n<li>Resource-intensive endpoints make users wait for the response longer so they retry. These retries add more demand to the already overloaded resource, slowing things down even more. The concurrent rate limiter helps address this nicely.</li>\n<li>Concurrent request limiters manage resource contention for CPU-intensive API endpoints.</li>\n</ul>\n<h3 id=\"fleet-usage-load-shedder\" style=\"position:relative;\"><a href=\"#fleet-usage-load-shedder\" aria-label=\"fleet usage load shedder permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fleet usage load shedder</h3>\n<ul>\n<li>Using this type of load shedder ensures that a certain percentage of your fleet will always be available for your most important API requests.</li>\n<li>2 types: critical API methods (e.g. creating charges) and non-critical methods (e.g. listing charges.)</li>\n</ul>\n<h3 id=\"worker-utilization-load-shedder-for-damage-control\" style=\"position:relative;\"><a href=\"#worker-utilization-load-shedder-for-damage-control\" aria-label=\"worker utilization load shedder for damage control permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Worker utilization load shedder (For damage control)</h3>\n<ul>\n<li>Most API services use a set of workers to independently respond to incoming requests in a parallel fashion. This load shedder is the final line of defense. If your workers start getting backed up with requests, then this will shed lower-priority traffic.</li>\n<li>\n<p>4 type for traffics:</p>\n<ul>\n<li>Critical methods</li>\n<li>POSTs</li>\n<li>GETs</li>\n<li>Test mode traffic</li>\n</ul>\n</li>\n<li>If a box is too busy to handle its request volume, it will slowly start shedding less-critical requests, starting with test mode traffic. If shedding test mode traffic gets it back into a good state, great! We can start to slowly bring traffic back. Otherwise, it’ll escalate and start shedding even more traffic.</li>\n</ul>\n<h3 id=\"implementation\" style=\"position:relative;\"><a href=\"#implementation\" aria-label=\"implementation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Implementation</h3>\n<ul>\n<li>Algorithm: <a href=\"https://en.wikipedia.org/wiki/Token_bucket\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Token Bucket</a></li>\n<li>In Practice: Hook the rate limiters into your middleware stack safely.</li>\n<li>Show clear exceptions to your users</li>\n<li>Build in safeguards so that you can turn off the limiters</li>\n<li>Dark launch each rate limiter to watch the traffic they would block</li>\n</ul>","frontmatter":{"title":"Api Design","date":"2020-07-26","description":null,"socialImage":null}}},"pageContext":{"slug":"/notes/api-design"}},"staticQueryHashes":["251939775","401334301","4017299803","825871152"]}